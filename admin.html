<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ‚Äì Review Map 247</title>

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;}
  body{
    background:#eef3fb;
    color:#111827;
    min-height:100vh;
  }

  header{
    background:#eef3fb;
    padding:16px 24px 12px;
    text-align:center;
    border-bottom:1px solid #dbe3f2;
  }
  .logo-heading{
    font-size:22px;
    font-weight:900;
    color:#d30000;
    letter-spacing:.5px;
    text-transform:uppercase;
    margin-top:6px;
  }
  .nav{
    display:flex;
    justify-content:center;
    gap:24px;
    margin-top:14px;
    flex-wrap:wrap;
  }
  .nav-item{
    font-size:15px;
    font-weight:600;
    color:#4b5563;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px 6px;
    border-radius:999px;
    transition:.2s;
  }
  .nav-item i{font-size:15px;}
  .nav-item:hover{
    background:#e5edf9;
    color:#111827;
  }
  .nav-item.active{
    color:#e11d48;
    font-weight:700;
  }

  .page-wrap{
    max-width:1150px;
    margin:26px auto 40px;
    padding:0 16px;
  }
  .card{
    background:#ffffff;
    border-radius:6px;
    border:1px solid #e5e7eb;
    box-shadow:0 10px 25px rgba(15,23,42,0.08);
    padding:18px 20px 20px;
    margin-bottom:18px;
  }
  .card-title{
    font-size:15px;
    font-weight:700;
    margin-bottom:10px;
  }

  .flex-row{
    display:flex;
    flex-wrap:wrap;
    gap:14px;
    align-items:flex-end;
    margin-bottom:10px;
  }
  .field{
    min-width:160px;
  }
  .field-label{
    font-size:13px;
    color:#4b5563;
    margin-bottom:4px;
  }
  input[type="number"],
  input[type="text"]{
    width:100%;
    padding:8px 10px;
    border-radius:4px;
    border:1px solid #d1d5db;
    font-size:14px;
    background:#f9fafb;
    outline:none;
  }
  input:focus{
    background:#ffffff;
    border-color:#60a5fa;
    box-shadow:0 0 0 1px rgba(59,130,246,.3);
  }
  .btn{
    border:none;
    padding:8px 14px;
    border-radius:4px;
    font-size:13px;
    font-weight:700;
    cursor:pointer;
    transition:.2s;
  }
  .btn-primary{
    background:#2563eb;
    color:#ffffff;
  }
  .btn-primary:hover{background:#1d4ed8;}
  .btn-save{
    background:#16a34a;
    color:#fff;
  }
  .btn-del{
    background:#dc2626;
    color:#fff;
  }

  .stats{
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    margin-top:10px;
    font-size:13px;
  }
  .stat-box{
    padding:8px 10px;
    border-radius:6px;
    background:#f9fafb;
    border:1px solid #e5e7eb;
  }
  .stat-box b{font-size:15px;}

  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
    margin-top:8px;
  }
  th,td{
    padding:7px 8px;
    border-bottom:1px solid #e5e7eb;
    text-align:left;
  }
  th{
    background:#f9fafb;
    font-weight:700;
    color:#4b5563;
    font-size:12px;
  }
  select{
    width:100%;
    padding:6px 8px;
    border-radius:4px;
    border:1px solid #d1d5db;
    background:#f9fafb;
    font-size:12px;
  }

  .toast{
    position:fixed;
    right:18px;
    bottom:18px;
    background:rgba(255,255,255,0.95);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.18);
    border:1px solid rgba(0,0,0,0.05);
    padding:10px 16px;
    display:flex;
    align-items:center;
    gap:8px;
    font-size:13px;
    font-weight:600;
    color:#111827;
    opacity:0;
    transform:translateY(20px);
    pointer-events:none;
    transition:.35s cubic-bezier(0.16,1,0.3,1);
    z-index:999;
  }
  .toast.show{
    opacity:1;
    transform:translateY(0);
    pointer-events:auto;
  }
</style>
</head>
<body>

<header>
  <div class="logo-heading">KHU V·ª∞C ADMIN</div>
  <nav class="nav">
    <a href="shop.html" class="nav-item">
      <i class="fa-solid fa-map-location-dot"></i> T·∫°o ƒê∆°n
    </a>
    <a href="account.html" class="nav-item">
      <i class="fa-solid fa-user"></i> T√†i Kho·∫£n
    </a>
    <a href="history.html" class="nav-item">
      <i class="fa-solid fa-clock-rotate-left"></i> L·ªãch S·ª≠
    </a>
    <a href="admin.html" class="nav-item active">
      <i class="fa-solid fa-gear"></i> Admin
    </a>
    <a href="login.html" class="nav-item" id="btnLogout">
      <i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng Xu·∫•t
    </a>
  </nav>
</header>

<div class="page-wrap">

  <!-- C·∫§U H√åNH GI√Å & T·ªîNG QUAN -->
  <div class="card">
    <div class="card-title">C·∫•u h√¨nh gi√° review & t·ªïng quan</div>
    <div class="flex-row">
      <div class="field">
        <div class="field-label">ƒê∆°n gi√° / 1 review (VND)</div>
        <input type="number" id="priceInput" min="1000" step="500">
      </div>
      <button class="btn btn-primary" id="btnSavePrice">L∆∞u ƒë∆°n gi√°</button>
    </div>
    <div class="stats">
      <div class="stat-box">
        T·ªïng t√†i kho·∫£n: <b id="statUsers">0</b>
      </div>
      <div class="stat-box">
        T·ªïng ƒë∆°n h√†ng: <b id="statOrders">0</b>
      </div>
      <div class="stat-box">
        T·ªïng review ƒë√£ ƒë·∫∑t: <b id="statReviews">0</b>
      </div>
    </div>
  </div>

  <!-- DANH S√ÅCH T√ÄI KHO·∫¢N -->
  <div class="card">
    <div class="card-title">Danh s√°ch t√†i kho·∫£n</div>
    <!-- üîç Thanh t√¨m ki·∫øm danh s√°ch t√†i kho·∫£n -->
    <div class="flex-row" style="margin-bottom:8px;justify-content:flex-start;">
      <input type="text" id="userSearch" placeholder="T√¨m username..." style="max-width:280px;">
    </div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Username</th>
          <th>Admin?</th>
          <th>Ng√†y t·∫°o</th>
          <th>ƒêƒÉng nh·∫≠p g·∫ßn nh·∫•t</th>
        </tr>
      </thead>
      <tbody id="userTable"></tbody>
    </table>
  </div>

  <!-- üéØ QU·∫¢N L√ù S·ªê D∆Ø T√ÄI KHO·∫¢N -->
  <div class="card">
    <div class="card-title">Qu·∫£n l√Ω s·ªë d∆∞ t√†i kho·∫£n</div>
    <!-- üîç Thanh t√¨m ki·∫øm s·ªë d∆∞ -->
    <div class="flex-row" style="margin-bottom:8px;justify-content:flex-start;">
      <input type="text" id="balanceSearch" placeholder="T√¨m username, s·ªë d∆∞..." style="max-width:280px;">
    </div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Username</th>
          <th>S·ªë d∆∞ hi·ªán t·∫°i</th>
          <th>S·ªë d∆∞ m·ªõi</th>
          <th>L∆∞u</th>
        </tr>
      </thead>
      <tbody id="balanceTable"></tbody>
    </table>
  </div>

  <!-- üéØ DUY·ªÜT L·ªÜNH N·∫†P TI·ªÄN -->
  <div class="card">
    <div class="card-title">L·ªánh n·∫°p ti·ªÅn t·ª´ ng∆∞·ªùi d√πng</div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>User</th>
          <th>S·ªë ti·ªÅn</th>
          <th>Ghi ch√∫ user</th>
          <th>Th·ªùi gian t·∫°o</th>
          <th>Tr·∫°ng th√°i</th>
          <th>Ghi ch√∫ admin</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="topupTable"></tbody>
    </table>
  </div>

  <!-- QU·∫¢N L√ù ƒê∆†N H√ÄNG -->
  <div class="card">
    <div class="card-title">Qu·∫£n l√Ω ƒë∆°n h√†ng (s·ª≠a tr·∫°ng th√°i & b·∫£o h√†nh)</div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>ID</th>
          <th>User</th>
          <th>Link Map</th>
          <th>SL</th>
          <th>Gi√°</th>
          <th>Tr·∫°ng th√°i</th>
          <th>B·∫£o h√†nh</th>
          <th>Ghi ch√∫</th>
          <th>Ng√†y t·∫°o</th>
          <th>L∆∞u</th>
        </tr>
      </thead>
      <tbody id="orderTable"></tbody>
    </table>
  </div>

</div>

<div class="toast" id="toast">ƒê√£ l∆∞u</div>

<script>
  // ===== CH·ªà ADMIN ƒê∆Ø·ª¢C V√ÄO =====
  const currentUser = localStorage.getItem("currentUser");
  const currentRole = localStorage.getItem("currentUserRole");

  if(!currentUser || currentRole !== "admin"){
    alert("Ch·ªâ admin m·ªõi ƒë∆∞·ª£c truy c·∫≠p!");
    window.location.href = "login.html";
  }

  document.getElementById("btnLogout").addEventListener("click", (e)=>{
    e.preventDefault();
    localStorage.removeItem("currentUser");
    localStorage.removeItem("currentUserRole");
    window.location.href="login.html";
  });

  // ===== TOAST =====
  const toast = document.getElementById("toast");
  let toastTimer = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove("show"), 2200);
  }

  // ===== DATA =====
  let users  = JSON.parse(localStorage.getItem("users")  || "[]");
  let orders = JSON.parse(localStorage.getItem("orders") || "[]");
  let adminConfig = JSON.parse(localStorage.getItem("adminConfig") || "{}");
  let topupRequests = JSON.parse(localStorage.getItem("topupRequests") || "[]");

  // ƒë·∫£m b·∫£o user n√†o c≈©ng c√≥ balance
  users.forEach(u => {
    if (typeof u.balance !== "number") u.balance = 0;
  });
  localStorage.setItem("users", JSON.stringify(users));

  // ===== GI√Å REVIEW =====
  const DEFAULT_PRICE = 14000;
  const priceInput = document.getElementById("priceInput");
  priceInput.value = adminConfig.reviewPrice || DEFAULT_PRICE;

  document.getElementById("btnSavePrice").addEventListener("click", ()=>{
    let v = parseInt(priceInput.value) || DEFAULT_PRICE;
    if(v < 1000) v = 1000;
    priceInput.value = v;
    adminConfig.reviewPrice = v;
    localStorage.setItem("adminConfig", JSON.stringify(adminConfig));
    showToast("ƒê√£ l∆∞u ƒë∆°n gi√°: " + v.toLocaleString("vi-VN") + "ƒë");
  });

  // ===== T·ªîNG QUAN =====
  const statUsers   = document.getElementById("statUsers");
  const statOrders  = document.getElementById("statOrders");
  const statReviews = document.getElementById("statReviews");

  statUsers.textContent   = users.length;
  statOrders.textContent  = orders.length;
  statReviews.textContent = orders.reduce((sum,o)=>sum+(o.quantity||0),0);

  // ===== B·∫¢NG USER =====
  const userTbody = document.getElementById("userTable");
  if(users.length === 0){
    userTbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#6b7280;">Kh√¥ng c√≥ t√†i kho·∫£n n√†o</td></tr>`;
  }else{
    users.forEach((u,idx)=>{
      const tr = document.createElement("tr");
      const created   = u.createdAt ? new Date(u.createdAt).toLocaleString("vi-VN") : "";
      const lastLogin = u.lastLogin ? new Date(u.lastLogin).toLocaleString("vi-VN") : "Ch∆∞a t·ª´ng";
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${u.username}</td>
        <td>${u.isAdmin ? "‚úÖ" : ""}</td>
        <td>${created}</td>
        <td>${lastLogin}</td>
      `;
      userTbody.appendChild(tr);
    });
  }

  // ===== B·∫¢NG QU·∫¢N L√ù S·ªê D∆Ø =====
  const balanceTbody = document.getElementById("balanceTable");
  if(users.length === 0){
    balanceTbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#6b7280;">Kh√¥ng c√≥ t√†i kho·∫£n n√†o</td></tr>`;
  }else{
    users.forEach((u,idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${u.username}</td>
        <td>${u.balance.toLocaleString("vi-VN")}ƒë</td>
        <td><input type="number" class="balanceInput" value="${u.balance}" min="0" step="1000"></td>
        <td><button class="btn btn-save btnBalanceSave">L∆∞u</button></td>
      `;
      balanceTbody.appendChild(tr);

      const inp = tr.querySelector(".balanceInput");
      const btn = tr.querySelector(".btnBalanceSave");

      btn.addEventListener("click", ()=>{
        let v = parseInt(inp.value);
        if(isNaN(v) || v < 0) v = 0;
        u.balance = v;
        localStorage.setItem("users", JSON.stringify(users));
        showToast("ƒê√£ c·∫≠p nh·∫≠t s·ªë d∆∞ cho " + u.username);
        tr.children[2].textContent = u.balance.toLocaleString("vi-VN") + "ƒë";
      });
    });
  }

  // ===== B·∫¢NG DUY·ªÜT L·ªÜNH N·∫†P TI·ªÄN (TH√äM T·ª™ CH·ªêI + GHI CH√ö ADMIN) =====
  const topupTbody = document.getElementById("topupTable");
  if (topupRequests.length === 0) {
    topupTbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#6b7280;">Ch∆∞a c√≥ l·ªánh n·∫°p n√†o</td></tr>`;
  } else {
    topupRequests.forEach((r, idx) => {
      const tr = document.createElement("tr");
      const created = r.createdAt ? new Date(r.createdAt).toLocaleString("vi-VN") : "";

      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${r.user}</td>
        <td>${(r.amount || 0).toLocaleString("vi-VN")}ƒë</td>
        <td>${r.note || ""}</td>
        <td>${created}</td>
        <td class="topup-status-cell">${r.status || "ƒêang x·ª≠ l√Ω"}</td>
        <td>
          <input type="text" class="topupNoteAdmin" placeholder="Ghi ch√∫ admin..."
                 value="${r.adminNote ? r.adminNote.replace(/"/g,'&quot;') : ""}">
        </td>
        <td class="topup-action-cell"></td>
      `;
      topupTbody.appendChild(tr);

      const statusCell = tr.querySelector(".topup-status-cell");
      const actionCell = tr.querySelector(".topup-action-cell");
      const noteAdminInput = tr.querySelector(".topupNoteAdmin");

      // T·∫°o 2 n√∫t: Duy·ªát + T·ª´ ch·ªëi
      const btnApprove = document.createElement("button");
      btnApprove.className = "btn btn-save";
      btnApprove.textContent = "Duy·ªát";

      const btnReject = document.createElement("button");
      btnReject.className = "btn btn-del";
      btnReject.style.marginLeft = "6px";
      btnReject.textContent = "T·ª´ ch·ªëi";

      actionCell.appendChild(btnApprove);
      actionCell.appendChild(btnReject);

      // Tr·∫°ng th√°i cu·ªëi: kh√¥ng cho thao t√°c n·ªØa
      function isFinalStatus(st) {
        return st === "Ho√†n th√†nh" || st === "T·ª´ ch·ªëi" || st === "H·ªßy l·ªánh" || st === "H·∫øt h·∫°n";
      }

      function disableButtons() {
        btnApprove.disabled = true;
        btnReject.disabled = true;
        btnApprove.style.opacity = "0.5";
        btnReject.style.opacity = "0.5";
        btnApprove.style.cursor = "default";
        btnReject.style.cursor = "default";
        noteAdminInput.readOnly = true;
      }

      if (isFinalStatus(r.status)) {
        disableButtons();
      }

      // üëâ DUY·ªÜT: c·ªông ti·ªÅn + ƒë·ªïi tr·∫°ng th√°i Ho√†n th√†nh, l∆∞u ghi ch√∫ admin
      btnApprove.addEventListener("click", () => {
        if (isFinalStatus(r.status)) return;

        const u = users.find(x => x.username === r.user);
        if (!u) {
          showToast("Kh√¥ng t√¨m th·∫•y user " + r.user);
          return;
        }

        const amount = parseInt(r.amount) || 0;
        u.balance = (u.balance || 0) + amount;

        r.status = "Ho√†n th√†nh";
        r.adminNote = noteAdminInput.value.trim();
        r.processedAt = new Date().toISOString();

        localStorage.setItem("users", JSON.stringify(users));
        localStorage.setItem("topupRequests", JSON.stringify(topupRequests));

        statusCell.textContent = r.status;
        disableButtons();
        showToast("ƒê√£ duy·ªát l·ªánh n·∫°p c·ªßa " + r.user);
      });

      // üëâ T·ª™ CH·ªêI: ƒë·ªïi tr·∫°ng th√°i T·ª´ ch·ªëi, l∆∞u ghi ch√∫ admin
      btnReject.addEventListener("click", () => {
        if (isFinalStatus(r.status)) return;

        r.status = "T·ª´ ch·ªëi";
        r.adminNote = noteAdminInput.value.trim();
        r.processedAt = new Date().toISOString();

        localStorage.setItem("topupRequests", JSON.stringify(topupRequests));

        statusCell.textContent = r.status;
        disableButtons();
        showToast("ƒê√£ t·ª´ ch·ªëi l·ªánh n·∫°p c·ªßa " + r.user);
      });
    });
  }

  // ===== B·∫¢NG ƒê∆†N H√ÄNG =====
  const orderTbody = document.getElementById("orderTable");
  if(orders.length === 0){
    orderTbody.innerHTML = `<tr><td colspan="11" style="text-align:center;color:#6b7280;">Kh√¥ng c√≥ ƒë∆°n n√†o</td></tr>`;
  }else{
    orders
      .sort((a,b)=>b.id-a.id)
      .forEach((o,idx)=>{
        const tr = document.createElement("tr");
        const created = o.createdAt ? new Date(o.createdAt).toLocaleString("vi-VN") : "";
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${o.id}</td>
          <td>${o.user}</td>
          <td style="max-width:180px;word-break:break-all;">
            <a href="${o.mapsLink || "#"}" target="_blank">${o.mapsLink || ""}</a>
          </td>
          <td>${o.quantity || 0}</td>
          <td>${o.unitPrice ? o.unitPrice.toLocaleString("vi-VN")+"ƒë" : ""}</td>
          <td>
            <select class="statusSel">
              <option ${o.status==="ƒêang ch·∫°y"?"selected":""}>ƒêang ch·∫°y</option>
              <option ${o.status==="Ho√†n th√†nh"?"selected":""}>Ho√†n th√†nh</option>
              <option ${o.status==="T·ª´ ch·ªëi"?"selected":""}>T·ª´ ch·ªëi</option>
              <option ${o.status==="ƒê√£ b·∫£o h√†nh"?"selected":""}>ƒê√£ b·∫£o h√†nh</option>
              <option ${o.status==="C√≤n b·∫£o h√†nh"?"selected":""}>C√≤n b·∫£o h√†nh</option>
              <option ${o.status==="H·∫øt b·∫£o h√†nh"?"selected":""}>H·∫øt b·∫£o h√†nh</option>
              <option ${o.status==="T·ª´ ch·ªëi b·∫£o h√†nh"?"selected":""}>T·ª´ ch·ªëi b·∫£o h√†nh</option>
            </select>
          </td>
          <td>
            <select class="warrantySel">
              <option value="" ${!o.warranty?"selected":""}>Kh√¥ng</option>
              <option ${o.warranty==="C√≤n b·∫£o h√†nh"?"selected":""}>C√≤n b·∫£o h√†nh</option>
              <option ${o.warranty==="H·∫øt b·∫£o h√†nh"?"selected":""}>H·∫øt b·∫£o h√†nh</option>
              <option ${o.warranty==="ƒê√£ b·∫£o h√†nh"?"selected":""}>ƒê√£ b·∫£o h√†nh</option>
              <option ${o.warranty==="T·ª´ ch·ªëi b·∫£o h√†nh"?"selected":""}>T·ª´ ch·ªëi b·∫£o h√†nh</option>
            </select>
          </td>
          <td>
            <input type="text" class="noteInput" value="${o.notice || ""}">
          </td>
          <td>${created}</td>
          <td><button class="btn btn-save">L∆∞u</button></td>
        `;
        orderTbody.appendChild(tr);

        const statusSel   = tr.querySelector(".statusSel");
        const warrantySel = tr.querySelector(".warrantySel");
        const noteInput   = tr.querySelector(".noteInput");
        const btnSave     = tr.querySelector(".btn-save");

        btnSave.addEventListener("click", ()=>{
          const oldStatus = o.status || "ƒêang ch·∫°y";
          const newStatus = statusSel.value;

          // üëâ N·∫øu chuy·ªÉn sang "T·ª´ ch·ªëi" l·∫ßn ƒë·∫ßu => ho√†n ti·ªÅn
          if(oldStatus !== "T·ª´ ch·ªëi" && newStatus === "T·ª´ ch·ªëi"){
            const u = users.find(x => x.username === o.user);
            if(u){
              const refundAmount = (o.unitPrice || 0) * (o.quantity || 0);
              u.balance = (u.balance || 0) + refundAmount;
              localStorage.setItem("users", JSON.stringify(users));
              showToast("ƒê√£ ho√†n " + (refundAmount||0).toLocaleString("vi-VN") + "ƒë cho " + o.user);
            }else{
              showToast("Kh√¥ng t√¨m th·∫•y user " + o.user);
            }
          }

          o.status   = newStatus;
          o.warranty = warrantySel.value || "";
          o.notice   = noteInput.value.trim();

          if(o.status === "Ho√†n th√†nh"){
            o.completedAt = new Date().toISOString();
          }

          localStorage.setItem("orders", JSON.stringify(orders));
          showToast("ƒê√£ l∆∞u ƒë∆°n #" + o.id);
        });
      });
  }

  /* =========================
     üéØ T√åM KI·∫æM + CHIA THEO NG√ÄY CHO ƒê∆†N H√ÄNG
     ========================= */
  (function(){
    const orderTbodyEl = document.getElementById("orderTable");
    if(!orderTbodyEl) return;

    const table = orderTbodyEl.closest("table");
    const card  = table.closest(".card");

    // T·∫°o thanh filter (t√¨m ki·∫øm + ch·ªçn ng√†y)
    const filterRow = document.createElement("div");
    filterRow.className = "flex-row";
    filterRow.style.justifyContent = "space-between";
    filterRow.style.marginBottom   = "8px";

    const searchInput = document.createElement("input");
    searchInput.type = "text";
    searchInput.id = "orderSearch";
    searchInput.placeholder = "T√¨m theo user, ID, link map...";
    searchInput.style.maxWidth = "280px";

    const dateInput = document.createElement("input");
    dateInput.type = "date";
    dateInput.id = "orderDateFilter";
    dateInput.style.maxWidth = "170px";
    dateInput.style.fontSize = "13px";

    filterRow.appendChild(searchInput);
    filterRow.appendChild(dateInput);

    card.insertBefore(filterRow, table);

    // G·∫Øn meta date cho t·ª´ng d√≤ng (d·ª±a theo id -> orders)
    const rows = Array.from(orderTbodyEl.querySelectorAll("tr"));
    const orderMap = {};
    orders.forEach(o => { orderMap[String(o.id)] = o; });

    rows.forEach(row => {
      const idCell = row.children[1];
      const createdCell = row.children[9];
      if(!idCell || !createdCell) return;
      const idText = idCell.textContent.trim();
      const o = orderMap[idText];
      let iso = "";
      let displayDate = "";
      if(o && o.createdAt){
        const d = new Date(o.createdAt);
        iso = d.toISOString().slice(0,10); // yyyy-mm-dd
        displayDate = d.toLocaleDateString("vi-VN");
      }else{
        const parts = (createdCell.textContent || "").split(",");
        displayDate = parts[0] || "";
      }
      row.dataset.dateIso = iso;
      row.dataset.dateDisplay = displayDate;
    });

    function applyFilter(){
      // Xo√° header ng√†y c≈©
      Array.from(orderTbodyEl.querySelectorAll("tr[data-date-header='1']")).forEach(r=>r.remove());

      const kw = searchInput.value.trim().toLowerCase();
      const dateVal = dateInput.value;

      const dataRows = Array.from(orderTbodyEl.querySelectorAll("tr"))
                            .filter(r => !r.dataset.dateHeader);

      dataRows.forEach(row => {
        const idText   = (row.children[1]?.textContent || "").toLowerCase();
        const userText = (row.children[2]?.textContent || "").toLowerCase();
        const linkText = (row.children[3]?.innerText   || "").toLowerCase();
        const dateIso  = row.dataset.dateIso || "";

        let show = true;
        if(kw && !(idText.includes(kw) || userText.includes(kw) || linkText.includes(kw))){
          show = false;
        }
        if(dateVal && dateIso && dateIso !== dateVal){
          show = false;
        }

        row.style.display = show ? "" : "none";
      });

      // Th√™m header cho t·ª´ng ng√†y (ch·ªâ c√°c d√≤ng ƒëang hi·ªÉn th·ªã)
      const visibleRows = Array.from(orderTbodyEl.querySelectorAll("tr"))
                               .filter(r => !r.dataset.dateHeader && r.style.display !== "none");

      let lastDate = "";
      visibleRows.forEach(row => {
        const dateDisp = row.dataset.dateDisplay;
        if(!dateDisp) return;
        if(dateDisp !== lastDate){
          lastDate = dateDisp;
          const headerRow = document.createElement("tr");
          headerRow.dataset.dateHeader = "1";
          headerRow.innerHTML = `
            <td colspan="11"
                style="background:#fef2f2;color:#b91c1c;font-weight:700;padding:6px 10px;border-bottom:1px solid #fecaca;">
              üìå Ng√†y ${dateDisp}
            </td>
          `;
          orderTbodyEl.insertBefore(headerRow, row);
        }
      });
    }

    searchInput.addEventListener("input", applyFilter);
    dateInput.addEventListener("change", applyFilter);

    // Ch·∫°y 1 l·∫ßn ƒë·ªÉ group theo ng√†y lu√¥n
    applyFilter();
  })();

  // =======================
  // üîç T√¨m ki·∫øm b·∫£ng users
  // =======================
  (function(){
    const userTbodyEl = document.getElementById("userTable");
    const searchInput = document.getElementById("userSearch");
    if(!userTbodyEl || !searchInput) return;

    searchInput.addEventListener("input", ()=>{
      const kw = searchInput.value.trim().toLowerCase();
      Array.from(userTbodyEl.querySelectorAll("tr")).forEach(row=>{
        const userText = (row.children[1]?.textContent || "").toLowerCase();
        row.style.display = userText.includes(kw) ? "" : "none";
      });
    });
  })();

  // =======================
  // üîç T√¨m ki·∫øm b·∫£ng s·ªë d∆∞ t√†i kho·∫£n
  // =======================
  (function(){
    const balanceTbodyEl = document.getElementById("balanceTable");
    const searchInput = document.getElementById("balanceSearch");
    if(!balanceTbodyEl || !searchInput) return;

    searchInput.addEventListener("input", ()=>{
      const kw = searchInput.value.trim().toLowerCase();
      Array.from(balanceTbodyEl.querySelectorAll("tr")).forEach(row=>{
        const userText = (row.children[1]?.textContent || "").toLowerCase();
        const balanceText = (row.children[2]?.textContent || "").toLowerCase();
        row.style.display = (userText.includes(kw) || balanceText.includes(kw)) ? "" : "none";
      });
    });
  })();
</script>

</body>
</html>
